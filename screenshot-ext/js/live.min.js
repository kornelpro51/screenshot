var DEBUGGER_VERSION = "1.0";
var WEBSTORE_URL = "https://chrome.google.com/webstore/";
var blankTab = null;
function toggleCaptureButton() {
    captureTraffic == !0 ? ($("#capture").parent().addClass("active"), $("#capture").children("i").removeClass("icon-ban-circle").addClass("icon-ok-circle")) : ($("#capture").parent().removeClass("active"), $("#capture").children("i").removeClass("icon-ok-circle").addClass("icon-ban-circle")), showInfo(selectedInfo)
}
function toggleRawViewButton() {
    settings.view_Raw == !0 ? ($("#rawView").parent().addClass("active"), $("#rawView").children("i").removeClass("icon-ban-circle").addClass("icon-ok-circle")) : ($("#rawView").parent().removeClass("active"), $("#rawView").children("i").removeClass("icon-ok-circle").addClass("icon-ban-circle")), showInfo(selectedInfo)
}
function saveSettings() {
    settings.cap_MainFrame == !1 && settings.cap_SubFrame == !1 && settings.cap_Stylesheet == !1 && settings.cap_Script == !1 && settings.cap_Image == !1 && settings.cap_Object == !1 && settings.cap_Xmlhttprequest == !1 && settings.cap_other == !1 && (settings.cap_MainFrame = !0, settings.cap_SubFrame = !0, settings.cap_Stylesheet = !0, settings.cap_Script = !0, settings.cap_Image = !0, settings.cap_Object = !0, settings.cap_Xmlhttprequest = !0, settings.cap_other = !0), localStorage.lhhSettings = JSON.stringify(settings)
}
function capture(n) {
    switch (n) {
        case "main_frame":
            return settings.cap_MainFrame;
        case "sub_frame":
            return settings.cap_SubFrame;
        case "stylesheet":
            return settings.cap_Stylesheet;
        case "script":
            return settings.cap_Script;
        case "image":
            return settings.cap_Image;
        case "object":
            return settings.cap_Object;
        case "xmlhttprequest":
            return settings.cap_Xmlhttprequest;
        case "other":
            return settings.cap_other
    }
    return !1
}
function resetAll() {
    selectedInfo = 0, 
    headerInfo = {}, 
    headerInfo.response = [], 
    headerInfo.request = [], 

    captureRequests = {};
    myTabs = {};
	httpRequests = {};
	requestCount = 0;

    $("#result").empty(), 
    $("#responseList > tbody").empty(), 
    $("#previewArea > div").empty().html(defaultText)
}
function resizeWindow() {
    $(".results").css("height", "0px"), $(".preview").css("width", "0px"), $("#mainTable").height($(window).height() - $(".nav-pills").height()), $(".results").css("height", $("#mainTable td").css("height")), $(".preview").css("width", $("#previewArea").css("width")), $(".codeBlock").height($("#previewArea").height()), $(".codeBlock").width($("#previewArea").width())
}
function showHeader(n) {
    var i = n - 1, 
    r = headerInfo.response[i].url, 
    u = headerInfo.response[i].statusLine.split(" "), 
    t = "";

    t += "<tr>", 
    t += '<td class="rId">' + (i + 1) + "<\/td>", 
    t += '<td class="rMe">' + headerInfo.request[i].method + "<\/td>", 
    t += '<td class="rSt"><span class="badge badge-' + getClassStyle(headerInfo.response[i].statusLine) + '">' + u[1] + "<\/span><\/td>",
    t += '<td><input type="text" class="inputUrl" value="' + r + '" /><\/td>', 
    t += "<\/tr>", 
    settings.list_Ascending == !0 ? (headerInfo.response.length >= 500 && $("#responseList > tbody tr").first().remove(), $("#responseList > tbody:last").append(t)) : (headerInfo.response.length >= 500 && $("#responseList > tbody tr").last().remove(), 
    $("#responseList > tbody:first").prepend(t))
}
function showInfo(n) {
    n != 0 && (settings.view_Raw == !0 ? showRawInfo(n) : showNiceInfo(n))
}
function showNiceInfo(n) {
    var i = n - 1, t, r, e, f, u;
    for (headerInfo.request[i].requestHeaders.sort(sortHeaders), headerInfo.response[i].responseHeaders.sort(sortHeaders), t = '<div class="results preview" style="overflow: auto;">', t += '<table class="table table-bordered table-condensed table-hover">', t += '<tr class="' + getClassStyle(headerInfo.response[i].statusLine) + '"><td colspan="2">', t += "<b>" + headerInfo.request[i].method + "<\/b> " + headerInfo.response[i].url + "<br /> <b>Status:<\/b> " + headerInfo.response[i].statusLine, t += "<\/td><\/tr>", t += '<tr class="warning"><td colspan="2"><b>Request Headers<\/b><\/td><\/tr>', r = 0, e = headerInfo.request[i].requestHeaders.length; r < e; ++r)
        f = headerInfo.request[i].requestHeaders[r].name, u = headerInfo.request[i].requestHeaders[r].value, f.toLowerCase() === "cookie" && (u = u.replace(/; /g, ";<br />")), t += "<tr>", t += '<th nowrap="nowrap" class="span2">' + f + "<\/th>", t += "<td>" + u + "<\/td>", t += "<\/tr>";
    for (t += '<tr class="warning"><td colspan="2"><b>Response Headers<\/b><\/td><\/tr>', r = 0, e = headerInfo.response[i].responseHeaders.length; r < e; ++r)
        f = headerInfo.response[i].responseHeaders[r].name, u = headerInfo.response[i].responseHeaders[r].value, f.toLowerCase() === "cookie" && (u = u.replace(/; /g, ";<br />")), t += "<tr>", t += '<th nowrap="nowrap">' + f + "<\/th>", t += "<td>" + u + "<\/td>", t += "<\/tr>";
    t += "<table><\/div>", $("#previewArea").empty().html(t), resizeWindow()
}
function showRawInfo(n) {
    var t = n - 1, i, r, f, e, o;
    headerInfo.request[t].requestHeaders.sort(sortHeaders), headerInfo.response[t].responseHeaders.sort(sortHeaders);
    var h = headerInfo.response[t].statusLine.split(" "), u = parseURL(headerInfo.response[t].url), s = u.host;
    for (u.port != undefined ? s += ":" + u.port : u.scheme == "https" && (s += ":443"), i = "", i += '<textarea wrap="off" class="codeBlock input-block-level" readonly="readonly" rows="{Rows1}">', i += headerInfo.request[t].method + " " + u.path + " " + h[0] + "\n", i += "Host: " + s + "\n", r = 0, f = headerInfo.request[t].requestHeaders.length; r < f; ++r)
        e = headerInfo.request[t].requestHeaders[r].name, o = headerInfo.request[t].requestHeaders[r].value, i += e + ": ", i += o + "\n";
    for (i += "\n", i += headerInfo.response[t].statusLine + "\n", r = 0, f = headerInfo.response[t].responseHeaders.length; r < f; ++r)
        e = headerInfo.response[t].responseHeaders[r].name, o = headerInfo.response[t].responseHeaders[r].value, i += e + ": ", i += o + "\n";
    i += "<\/textarea>", $("#previewArea").empty().html(i), resizeWindow()
}

function uiShowRequest(requestId) {
    t = "<tr id='tr_" + requestId + "'>";
    t += '<td class="rId">' + captureRequests[requestId].no + "<\/td>";
    if (/^[\_]\d*[\_]$/.test(requestId)) {
		t += '<td class="rMe">' + "manual" + "<\/td>";
    } else {
    	t += '<td class="rMe">' + requestId + "<\/td>";
    }
    t += '<td class="rSt">' + captureRequests[requestId].status +"<\/td>";
    t += '<td><input type="text" class="inputUrl" value="' + captureRequests[requestId].url + '" /><\/td>';
    t += "<\/tr>";
    requestCount >= 500 && $("#responseList > tbody tr").last().remove();
    $("#responseList > tbody:first").prepend(t);
}
function uiUpdateRequest (requestId) {
	$("#tr_"+requestId).find('.rSt').text(captureRequests[requestId].status);
}
function showDetailInfo (requestId) {
	if (!captureRequests[requestId].tab) {
		$("#previewArea > div").html("");
		return;
	}
	if (!httpRequests[captureRequests[requestId].tab.id]) {
		$("#previewArea > div").html("");
		return;
	}
	var v = httpRequests[captureRequests[requestId].tab.id];
	t = "<h4>"+v.responseCount+"/"+v.requestCount+"</h4>"
	t += "<table>";
	t += "<thead>";
	t += "<th>Method</th>";
	t += "<th>Status</th>";
	t += "<th>URL</th>";
	t += "<th>Start Time</th>";
	t += "<th>End Time</th>";
	t += "</thead>";
	t += "<tbody>";
	for (var idx in v.request ) {
		t += "<tr>";
		t += "<td>" + v.request[idx].method + "</td>";
        if (typeof v.response[idx] != 'undefined') {
            t += "<td>" + v.response[idx].status + "</td>";
        } else {
            t += "<td></td>";
        }
		t += '<td title="'+v.request[idx].url+'""><input type="text" class="inputUrl" value="' +  v.request[idx].url + '" /></td>';
		t += "<td title='"+v.request[idx].timestamp+"'>" + (new Date(v.request[idx].timestamp)).toLocaleTimeString() + "</td>";
        if (typeof v.response[idx] != 'undefined') {
            t += "<td title='"+v.response[idx].timestamp+"'>" + (new Date(v.response[idx].timestamp)).toLocaleTimeString() + "</td>";
        } else {
            t += "<td></td>";
        }
		
		t += "<\/tr>";
	}
	t += "</tbody>";
	t += "</table>";
	$("#previewArea > div").html(t);
}

function checkTabLoadingStatus(tabId, extra) {
	//console.log(tabId, httpRequests[tabId].requestCount, httpRequests[tabId].responseCount, httpRequests[tabId].timeoutCheck,extra);
	if (!httpRequests[tabId]) {
		//console.log(" return condition 1 ");
		return;
	}
    if (httpRequests[tabId].requestCount != httpRequests[tabId].responseCount || httpRequests[tabId].requestCount != httpRequests[tabId].prevRequestCount) {
        httpRequests[tabId].prevRequestCount = httpRequests[tabId].requestCount;
        httpRequests[tabId].timeoutCheck = 0;
        //console.log(" return condition 2 ");
        return;
    }
    if (!httpRequests[tabId].isDOMLoaded) {
        //console.log(" return condition 3 ");
        return;
    }
    if (!httpRequests[tabId].isSWFLoaded) {
        //console.log(" return condition 3-1 ");
        return;
    }
	httpRequests[tabId].prevRequestCount = httpRequests[tabId].requestCount;
	if (!httpRequests[tabId].timeoutCheck) {
		httpRequests[tabId].timeoutCheck = 0;
	}
	if (httpRequests[tabId].timeoutCheck < 3) {
		httpRequests[tabId].timeoutCheck++;
		setTimeout(function(){
			checkTabLoadingStatus(tabId, "-- repeate --")
		}, 200);
		//console.log(" return condition 4 ");
		return;
	}
	if (!httpRequests[tabId].loadingCompleted) {
		httpRequests[tabId].loadingCompleted = true;
		takeScreenshot(tabId);
	}
}
var headerInfo = {}, settings = {}, tabId = "", selectedInfo = 0, captureTraffic = !0, defaultText = "";
var myTabs = {};
var httpRequests = {};
var captureRequests = {};
var socket = null;
var requestCount = 0;
var INITIAL = 'Init', LOADING = 'Loading', DONE = 'Complete';
var isCaptureProcessing = false;
var captureQueue = [];

socket = io.connect('http://localhost:3000');
socket.on('init', function() {
	//console.log(" * web socket - init connection");
});

socket.on('docapture', function (data) {
	startCapture(data.url, data.requestId);
	//console.log(" * startCapture - " + data.url);
});

function startCapture(newUrl, requestId) {
	requestCount++;
	var newRequest = {
		no          : requestCount,
		requestId   : requestId,
		url         : newUrl,
		status      : INITIAL,
		tab         : null,
		httpHistory : null
	};
	captureRequests[requestId]= newRequest;

	uiShowRequest(requestId);	
    chrome.windows.create({url:newUrl, focused: false, incognito: false, type: "normal", width: 1500, height: 1000}, function(window) {
        if (window.tabs.length < 1) {
            console.error (" * fatal - can not get tab * ");
        }
        var tab = window.tabs[0];
        chrome.debugger.attach({tabId:tab.id}, DEBUGGER_VERSION,
            function() {
                chrome.debugger.sendCommand({tabId:tab.id}, "Network.enable");
            });
        tab.requestId = requestId;
        myTabs[tab.id] = tab;
        newRequest.tab = tab;
        newRequest.status = LOADING;
        uiUpdateRequest(requestId);
    });
    /*chrome.tabs.create({url:newUrl}, function(tab) {
        chrome.debugger.attach({tabId:tab.id}, DEBUGGER_VERSION,
            function() {
                chrome.debugger.sendCommand({tabId:tab.id}, "Network.enable");
            });
        tab.requestId = requestId;
        myTabs[tab.id] = tab;
        newRequest.tab = tab;
        newRequest.status = LOADING;
        uiUpdateRequest(requestId);
    });*/
}
function processNewTab() {
    
}

function takeScreenshot(tabId) {
	//console.log("takeScreenshot", tabId, myTabs[tabId]);
	if (!myTabs[tabId]) {
		//console.log("*************** Exceptional Error ****************")
		return;
	}
	if (isCaptureProcessing) {
		captureQueue.push(tabId);
	} else {
		isCaptureProcessing = true;
		processScreenshot(tabId);
	}
}

function processScreenshot(tabId) {
	var canvas;
	httpRequests[tabId].screenshot = {}

    var scale = 1;

    if (!httpRequests[tabId].screenshot.canvas) {
        canvas = document.createElement('canvas');
        canvas.width = myTabs[tabId].width;
        canvas.height = myTabs[tabId].height;
        httpRequests[tabId].screenshot.canvas = canvas;
        httpRequests[tabId].screenshot.ctx = canvas.getContext('2d');
    }
    chrome.tabs.captureVisibleTab(
    myTabs[tabId].windowId, {format: 'png', quality: 100}, function(dataURI) {
        if (dataURI) {
            var image = new Image();
            image.onload = function() {
                httpRequests[tabId].screenshot.ctx.drawImage(image, 0, 0);
                CompleteCapture(tabId, function() {
                    if (captureQueue.length > 0) {
                        processScreenshot(captureQueue.shift());
                    } else {
                        isCaptureProcessing = false;
                    }
                });
            };
            image.src = dataURI;
        }
    });
}

function CompleteCapture(tabId, callback) {
	captureRequests[myTabs[tabId].requestId].status = DONE;
	uiUpdateRequest(myTabs[tabId].requestId);

	if (/^[\_]\d*[\_]$/.test(myTabs[tabId].requestId)) {
		openPage(tabId, callback);
	} else {
		var dataURI = httpRequests[tabId].screenshot.canvas.toDataURL();
		socket.emit('captureresult', {url: myTabs[tabId].url, data: dataURI, requestId: myTabs[tabId].requestId});
		//console.log(" * Capture ended - " + myTabs[tabId].url);
		//callback();
		chrome.tabs.remove(tabId, function(){
			callback();
		});
	}
}

function openPage(tabId, callback) {
    var dataURI = httpRequests[tabId].screenshot.canvas.toDataURL();
    var byteString = atob(dataURI.split(',')[1]);
    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    var blob = new Blob([ab], {type: mimeString});
    var name = myTabs[tabId].url.split('?')[0].split('#')[0];
    if (name) {
        name = name
            .replace(/^https?:\/\//, '')
            .replace(/[^A-z0-9]+/g, '-')
            .replace(/-+/g, '-')
            .replace(/^[_\-]+/, '')
            .replace(/[_\-]+$/, '');
        name = '-' + name;
    } else {
        name = '';
    }
    name = 'screencapture' + name + '.png';
    function onwriteend() {
        window.open('filesystem:chrome-extension://' + chrome.i18n.getMessage('@@extension_id') + '/temporary/' + name);
        callback();
    }
    function errorHandler() {
        show('uh-oh');
    }
    window.webkitRequestFileSystem(TEMPORARY, 1024*1024, function(fs){
        fs.root.getFile(name, {create:true}, function(fileEntry) {
            fileEntry.createWriter(function(fileWriter) {
                fileWriter.onwriteend = onwriteend;
                fileWriter.write(blob);
            }, errorHandler);
        }, errorHandler);
    }, errorHandler);
}
function GetRealPath(url) {
    return url;
}
var exceptionHandler = setInterval( function () {
    var current = Date.now();
    for (var tabId in httpRequests) {
        if (httpRequests[tabId].isDOMLoaded && !httpRequests[tabId].loadingCompleted) {
            if (httpRequests[tabId].loadedTime + 15000 < current) {
                httpRequests[tabId].isSWFLoaded = true;
                httpRequests[tabId].loadingCompleted = true;
                takeScreenshot(parseInt(tabId));
            }
        }
    }
}, 3000);
window.onunload = function() {
    clearInterval(exceptionHandler);
};
$(function() {
    headerInfo.response = [], 
    headerInfo.request = [], 
    defaultText = $("#previewArea").html();
    
    chrome.debugger.onEvent.addListener(function(debuggeeId, message, params) {
        console.log("* debugger * ", debuggeeId, message, params);
        var tabId = debuggeeId.tabId;
        if (typeof myTabs[tabId] == 'undefined') {
            return;
        }
        if (!httpRequests[tabId]) {
            httpRequests[tabId] = {request: {}, response: {}, blacklistURLs: [], timeoutCheck: 0, loadingCompleted: false, prevRequestCount: 0, isDOMLoaded: false}
            captureRequests[myTabs[tabId].requestId].httpHistory = httpRequests[tabId];
            if (message == "Network.responseReceived") {
                httpRequests[tabId].requestCount = 1;
                httpRequests[tabId].responseCount = 1;
                httpRequests[tabId].request[params.requestId] = {method: "GET", url: params.response.url, timestamp: params.timestamp};
                httpRequests[tabId].response[params.requestId] = {mimeType: params.response.mimeType, status: params.response.status, statusText: params.response.statusText, timestamp: params.timestamp};
            } else if (message == "Network.loadingFailed") {
                httpRequests[tabId].requestCount = 1;
                httpRequests[tabId].responseCount = 1;
                httpRequests[tabId].request[params.requestId] = {method: "GET", url: params.response.url, timestamp: params.timestamp};
                httpRequests[tabId].response[params.requestId] = {mimeType: params.response.mimeType, status: params.response.status, statusText: params.response.statusText, timestamp: params.timestamp};
            } else {
                console.error(" * fatal error * ");
            }
        } else {
            if (message == "Network.responseReceived") {
                if (httpRequests[tabId].request[params.requestId]) {
                    httpRequests[tabId].response[params.requestId] = {mimeType: params.response.mimeType, status: params.response.status, statusText: params.response.statusText };
                }
            } else if (message == "Network.loadingFinished") {
                if (httpRequests[tabId].request[params.requestId]) {
                    if (typeof httpRequests[tabId].response[params.requestId].timestamp == 'undefined') {
                        httpRequests[tabId].responseCount++;
                    }
                    httpRequests[tabId].response[params.requestId].timestamp = params.timestamp;
                    checkTabLoadingStatus(tabId, "--- from Listener ---");
                }
            } else if (message == "Network.loadingFailed") {
                if (httpRequests[tabId].request[params.requestId]) {
                    if (typeof httpRequests[tabId].response[params.requestId].timestamp == 'undefined') {
                        httpRequests[tabId].responseCount++;
                    }
                    httpRequests[tabId].response[params.requestId].timestamp = params.timestamp;
                    checkTabLoadingStatus(tabId, "--- from Listener ---");
                }
            } else if (message == "Network.requestWillBeSent") {
                if (typeof httpRequests[tabId].request[params.requestId] == 'undefined') {
                    httpRequests[tabId].requestCount++;
                }
                if (httpRequests[tabId].isDOMLoaded == true) {
                    var realPath = GetRealPath(params.request.url);
                    if ( $.inArray(realPath, httpRequests[tabId].blacklistURLs) < 0 ) {
                        httpRequests[tabId].blacklistURLs.push(realPath);
                        httpRequests[tabId].request[params.requestId] = {method: params.request.method, url: params.request.url};
                    }
                } else {
                    httpRequests[tabId].request[params.requestId] = {method: params.request.method, url: params.request.url};
                }
            } else if (message == "Network.dataReceived") {
            } else {
                console.error(" * error - unknown response * ");
            }
        }
    });
    chrome.tabs.onUpdated.addListener(function(tabId, changeInfo) {
	    if (changeInfo.status === 'complete') {
            //console.log(tabId, ' ************ COMPLETE *********** ')
	    	if (myTabs[tabId]) {
	    		chrome.tabs.executeScript(tabId, {file: 'js/hidescroll.js'}, function() {
	    			if (myTabs[tabId].url.substring(0, 35) == WEBSTORE_URL) {
                        httpRequests[tabId].isDOMLoaded = true;
                        httpRequests[tabId].isSWFLoaded = true;
                        httpRequests[tabId].loadedTime = Date.now();
                        checkTabLoadingStatus(tabId, "---- from DOM complete Listener ------");
                    } else if (httpRequests[tabId]) {
	    				httpRequests[tabId].isDOMLoaded = true;
                        httpRequests[tabId].loadedTime = Date.now();
	    				checkTabLoadingStatus(tabId, "---- from DOM complete Listener ------");
	    			} else {
	    				console.error("**** fatal error ( If 'myTabs' has this tabId, 'httpRequest' also should have this tabId ) ****");
	    			}
				});
	    	}
	    }
	}),
    chrome.tabs.onRemoved.addListener(function(tabId, removeInfo) {
        chrome.debugger.detach({tabId:tabId});
    }),
    chrome.extension.onRequest.addListener(function(request, sender, callback) {
        if (request.msg === 'swfcomplete') {
            if ( httpRequests[sender.tab.id] ) {
                httpRequests[sender.tab.id].isSWFLoaded = true;
                checkTabLoadingStatus(sender.tab.id, "---- from SWF complete Listener ------");
            }
        } else {
            //console.error('Unknown message received from content script: ' + request.msg);
        }
    }),

    $("#responseList").click(function(n) {
        if (n.toElement.nodeName.toLowerCase() == "td" || n.toElement.nodeName.toLowerCase() == "input" || n.toElement.nodeName.toLowerCase() == "span") {
            var t = $(n.toElement).closest("tr").attr("id");
            $(n.toElement).closest("tr").children("td").children("input").select(), 
            showDetailInfo(t.substring(3));
        }
    }), 

    $("#clearAll").click(function() {
        resetAll()
    }), 

    $("#rawView").click(function() {
        settings.view_Raw = settings.view_Raw == !1, saveSettings(), toggleRawViewButton()
    }), 

    $("#capture").click(function() {
        captureTraffic = captureTraffic == !1, showInfo(selectedInfo), toggleCaptureButton()
    }), 
    $("#settings").click(function() {
        $("#setMainFrame").prop("checked", settings.cap_MainFrame), 
        $("#setSubFrame").prop("checked", settings.cap_SubFrame), 
        $("#setStylesheet").prop("checked", settings.cap_Stylesheet), 
        $("#setScript").prop("checked", settings.cap_Script), 
        $("#setImage").prop("checked", settings.cap_Image), 
        $("#setObject").prop("checked", settings.cap_Object), 
        $("#setXHR").prop("checked", settings.cap_Xmlhttprequest), 
        $("#setOther").prop("checked", settings.cap_other), 
        settings.view_Raw == !0 ? ($("#viewTypeNice").prop("checked", !1), $("#viewTypeRaw").prop("checked", !0)) : ($("#viewTypeRaw").prop("checked", !1), $("#viewTypeNice").prop("checked", !0)), 
        settings.list_Ascending == !0 ? ($("#listDescending").prop("checked", !1), $("#listAscending").prop("checked", !0)) : ($("#listAscending").prop("checked", !1), $("#listDescending").prop("checked", !0))
    }),

    $("#saveSettings").click(function() {
        settings.cap_MainFrame = $("#setMainFrame").prop("checked"), 
        settings.cap_SubFrame = $("#setSubFrame").prop("checked"), 
        settings.cap_Stylesheet = $("#setStylesheet").prop("checked"), 
        settings.cap_Script = $("#setScript").prop("checked"), 
        settings.cap_Image = $("#setImage").prop("checked"), 
        settings.cap_Object = $("#setObject").prop("checked"), 
        settings.cap_Xmlhttprequest = $("#setXHR").prop("checked"), 
        settings.cap_other = $("#setOther").prop("checked"), 
        settings.view_Raw = $("#viewTypeRaw").prop("checked");

        var n = $("#listAscending").prop("checked");
        settings.list_Ascending != n && (settings.list_Ascending = $("#listAscending").prop("checked"), resetAll()), toggleRawViewButton(), saveSettings(), 
        $("#myModal").modal("hide")
    })

    $("#btn_openTab").click(function() {
        var time = new Date();
        var id = '_' + time.getTime() + '_';
	    startCapture($("#txt_new_url").val(), id)
	    $("#newTab").modal("hide")
    });
    

    var n = localStorage.lhhSettings;
    n != undefined ? settings = JSON.parse(n) : (settings.cap_MainFrame = !0, settings.cap_SubFrame = !0, settings.cap_Stylesheet = !0, settings.cap_Script = !0, settings.cap_Image = !0, settings.cap_Object = !0, settings.cap_Xmlhttprequest = !0, settings.cap_other = !0, settings.view_Raw = !0, settings.list_Ascending = !1, saveSettings()), chrome.tabs.getCurrent(function(n) {
        chrome.extension.getBackgroundPage().viewTabId = n.id
    }), resizeWindow(), toggleRawViewButton()

	/*chrome.tabs.create({url:'about:blank'}, function(tab) {
        blankTab = tab;
    });*/
});
$(window).resize(function() {
    resizeWindow()
});